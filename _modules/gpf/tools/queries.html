

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gpf.tools.queries &mdash; gpf3 0.4.dev27+ga276b54.d20200203 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> gpf3
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gpf.html">gpf package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">gpf3</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>gpf.tools.queries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gpf.tools.queries</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2019 Geocom Informatik AG / VertiGIS</span>

<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>

<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module that facilitates working with basic SQL expressions and where clauses in ArcGIS.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">_tp</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span> <span class="k">as</span> <span class="n">_wraps</span>

<span class="kn">import</span> <span class="nn">more_itertools</span> <span class="k">as</span> <span class="nn">_iter</span>

<span class="kn">import</span> <span class="nn">gpf.common.const</span> <span class="k">as</span> <span class="nn">_const</span>
<span class="kn">import</span> <span class="nn">gpf.common.guids</span> <span class="k">as</span> <span class="nn">_guids</span>
<span class="kn">import</span> <span class="nn">gpf.common.textutils</span> <span class="k">as</span> <span class="nn">_tu</span>
<span class="kn">import</span> <span class="nn">gpf.common.validate</span> <span class="k">as</span> <span class="nn">_vld</span>
<span class="kn">from</span> <span class="nn">gpf</span> <span class="k">import</span> <span class="n">arcpy</span> <span class="k">as</span> <span class="n">_arcpy</span>
<span class="kn">from</span> <span class="nn">gpf.paths</span> <span class="k">import</span> <span class="n">Workspace</span> <span class="k">as</span> <span class="n">_Ws</span>

<span class="n">WHERE_KWARG</span> <span class="o">=</span> <span class="s1">&#39;where_clause&#39;</span>


<span class="k">def</span> <span class="nf">_return_new</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Decorator function to execute instance method *func* on a new copy of the original instance. &quot;&quot;&quot;</span>
    <span class="nd">@_wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">new_instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="n">new_instance</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_instance</span>
    <span class="k">return</span> <span class="n">wrapped</span>


<span class="c1"># noinspection PyPep8Naming</span>
<div class="viewcode-block" id="Where"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where">[docs]</a><span class="k">class</span> <span class="nc">Where</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Where(field_or_clause)</span>

<span class="sd">    Basic query helper class to build basic SQL expressions for ArcPy tools where clauses.</span>
<span class="sd">    Because all methods return a new instance, the user can &quot;daisy chain&quot; multiple statements.</span>

<span class="sd">    When used in combination with the :py:mod:`gpf.cursors` module, the Where clause can be passed-in directly.</span>
<span class="sd">    In other cases (e.g. *arcpy* tools), the resulting SQL expression is obtained using :func:`str`, :func:`unicode`</span>
<span class="sd">    or :func:`repr`. Note that the first 2 functions check if the resulting expression is a complete SQL query.</span>
<span class="sd">    Since Esri&#39;s *arcpy* prefers ``unicode`` text, the :func:`unicode` function is recommended over the :func:`str`.</span>

<span class="sd">    Example of a simple query:</span>

<span class="sd">        &gt;&gt;&gt; Where(&#39;A&#39;).GreaterThanOrEquals(3.14)</span>
<span class="sd">        A &gt;= 3.14</span>

<span class="sd">    The :func:`In` and :func:`NotIn` functions accept multiple arguments or an iterable as input.</span>
<span class="sd">    The following example shows how boolean values are interpreted as integers and that duplicates are removed:</span>

<span class="sd">        &gt;&gt;&gt; Where(&#39;A&#39;).NotIn(1, 2, True, False, 3)</span>
<span class="sd">        A NOT IN (0, 1, 2, 3)</span>

<span class="sd">    The :func:`Between` and :func:`NotBetween` functions also accept multiple arguments or an iterable as input.</span>
<span class="sd">    The resulting SQL expression will only use the lower and upper values of the input list,</span>
<span class="sd">    as shown in the following composite query example:</span>

<span class="sd">        &gt;&gt;&gt; Where(&#39;A&#39;).Like(&#39;Test%&#39;).Or(&#39;B&#39;).Between([8, 5, 3, 4])</span>
<span class="sd">        A LIKE &#39;Test%&#39; OR B BETWEEN 3 AND 8</span>

<span class="sd">    The following example demonstrates how you can make a grouped composite query using the :func:`combine` function:</span>

<span class="sd">        &gt;&gt;&gt; combine(Where(&#39;A&#39;).Equals(1).And(&#39;B&#39;).Equals(0)).Or(&#39;C&#39;).IsNull()</span>
<span class="sd">        (A = 1 AND B = 0) OR C IS NULL</span>

<span class="sd">    **Params:**</span>

<span class="sd">    -   **where_field** (str, unicode, gpf.tools.queries.Where):</span>

<span class="sd">        The initial field to start the where clause, or another `Where` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Private class constants</span>
    <span class="n">__SQL_OR</span> <span class="o">=</span> <span class="n">_const</span><span class="o">.</span><span class="n">TEXT_OR</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">__SQL_AND</span> <span class="o">=</span> <span class="n">_const</span><span class="o">.</span><span class="n">TEXT_AND</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">__SQL_NOT</span> <span class="o">=</span> <span class="s1">&#39;NOT&#39;</span>
    <span class="n">__SQL_IS</span> <span class="o">=</span> <span class="s1">&#39;IS&#39;</span>
    <span class="n">__SQL_IN</span> <span class="o">=</span> <span class="s1">&#39;IN&#39;</span>
    <span class="n">__SQL_NULL</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
    <span class="n">__SQL_LIKE</span> <span class="o">=</span> <span class="s1">&#39;LIKE&#39;</span>
    <span class="n">__SQL_BETWEEN</span> <span class="o">=</span> <span class="s1">&#39;BETWEEN&#39;</span>
    <span class="n">__SQL_ESCAPE</span> <span class="o">=</span> <span class="s1">&#39;ESCAPE&#39;</span>
    <span class="n">__SQL_EQ</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span>
    <span class="n">__SQL_LE</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span>
    <span class="n">__SQL_GE</span> <span class="o">=</span> <span class="s1">&#39;&gt;=&#39;</span>
    <span class="n">__SQL_LT</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="n">__SQL_GT</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span>
    <span class="n">__SQL_NE</span> <span class="o">=</span> <span class="s1">&#39;&lt;&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Where&#39;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_new</span><span class="p">(</span><span class="n">field_or_clause</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the where clause SQL string representation of this Where instance.</span>
<span class="sd">        Note that str() and repr() will both return the same string when called on the instance.</span>
<span class="sd">        However, repr() does not check if the constructed query is valid.</span>

<span class="sd">        :return:    A where clause SQL expression string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the where clause SQL encoded string representation of this Where instance.</span>

<span class="sd">        :return:            A where clause SQL expression string.</span>
<span class="sd">        :rtype:             str</span>
<span class="sd">        :raises ValueError: If the query has not been finished properly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns ``True`` when the other object is of the same type and/or represents the same SQL expression. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Where</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_add_any</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">is_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_conjunction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generic method to add a new part (field name, operator, or value) to the current query. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_field</span> <span class="ow">or</span> <span class="n">is_conjunction</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Adding </span><span class="si">{value!r}</span><span class="s1"> would create an invalid query&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">is_field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds an expression (consisting of multiple parts) to the current query. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_any</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Adds a field to the query (combine or init). &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_any</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_add_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">:</span> <span class="s1">&#39;Where&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds another clause to the query (combine or init).</span>

<span class="sd">        :type clause:   Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy all parts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">clause</span><span class="o">.</span><span class="n">_parts</span><span class="p">)</span>

        <span class="c1"># Copy the _isdirty state of the input query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">_isdirty</span>

    <span class="k">def</span> <span class="nf">_add_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Where&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Adds a new field or a complete clause to the current query. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_or_clause</span><span class="p">,</span> <span class="n">Where</span><span class="p">):</span>
            <span class="c1"># Add a whole Where clause</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_clause</span><span class="p">(</span><span class="n">field_or_clause</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_or_clause</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Add a new field and set state to dirty</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">field_or_clause</span><span class="p">)</span>

        <span class="c1"># At this point, the passed-in argument is invalid</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&#39;field_or_clause&#39; must be a field name or </span><span class="si">{self.__class__.__name__}</span><span class="s2"> instance&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Where&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Instructs Where instance to append a new query using the AND or OR conjunction. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_any</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">is_conjunction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_new</span><span class="p">(</span><span class="n">field_or_clause</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Concatenates all query parts to form an actual SQL expression. Can check if the query is dirty. &quot;&quot;&quot;</span>
        <span class="n">_vld</span><span class="o">.</span><span class="n">raise_if</span><span class="p">(</span><span class="n">check</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Cannot output invalid query&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;{_const.CHAR_SPACE.join(part for part, _ in self._parts)}&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_types</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Checks that all query values have compatible data types. Applies to IN and BETWEEN operators. &quot;&quot;&quot;</span>

        <span class="c1"># Check that none of the arguments are of type &#39;object&#39; (this breaks the type check)</span>
        <span class="n">_vld</span><span class="o">.</span><span class="n">raise_if</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="nb">object</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="p">),</span>
                      <span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Values of type object are not allowed in IN and BETWEEN queries&#39;</span><span class="p">)</span>

        <span class="c1"># Get the first value and get its type</span>
        <span class="n">sample_val</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sample_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">sample_val</span><span class="p">)</span>

        <span class="c1"># Allow for some flexibility concerning numbers</span>
        <span class="k">if</span> <span class="n">_vld</span><span class="o">.</span><span class="n">is_number</span><span class="p">(</span><span class="n">sample_val</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># For now, we will allow a mixture of floats and integers (and bools) in the list of values</span>
            <span class="n">sample_type</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">sample_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to format *value* for use in an SQL expression based on its type.</span>
<span class="sd">        This basically means that all non-numeric values (strings) will be quoted.</span>
<span class="sd">        If value is a :class:`gpf.common.guids.Guid` instance, the result will be wrapped in curly braces and quoted.</span>

<span class="sd">        :param value:   Any value. Single quotes in strings will be escaped automatically.</span>
<span class="sd">        :return:        A formatted string.</span>
<span class="sd">        :rtype:         unicode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_vld</span><span class="o">.</span><span class="n">is_number</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># Note: a `bool` is of instance `int` but calling format() on it will return a string (True or False).</span>
            <span class="c1"># To prevent this from happening, we&#39;ll use the `real` numeric part instead (on int, float and bool).</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_guids</span><span class="o">.</span><span class="n">Guid</span><span class="p">):</span>
            <span class="c1"># Parse Guid instances as strings</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_vld</span><span class="o">.</span><span class="n">is_text</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_tu</span><span class="o">.</span><span class="n">to_repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All values in an SQL expression must be text strings or numeric values&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">min_required</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Flattens the IN/BETWEEN query values, performs several checks, and returns the list if ok. &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_iter</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">_vld</span><span class="o">.</span><span class="n">pass_if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_required</span><span class="p">,</span>
                     <span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{operator}</span><span class="s1"> query requires at least </span><span class="si">{min_required}</span><span class="s1"> value&#39;</span><span class="p">)</span>
        <span class="n">_vld</span><span class="o">.</span><span class="n">pass_if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_types</span><span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="p">),</span>
                     <span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{operator}</span><span class="s1"> query values must have similar data types&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds an (NOT) IN expression to the SQL query. &quot;&quot;&quot;</span>
        <span class="n">flat_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_values</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">operator</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;({_const.TEXT_COMMASPACE.join((self._format_value(v) for v in sorted(frozenset(flat_values))))})&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a (NOT) BETWEEN .. AND .. expression to the SQL query. &quot;&quot;&quot;</span>
        <span class="n">flat_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_values</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">operator</span><span class="p">)</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">flat_values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">flat_values</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_AND</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">escape_char</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Adds a (NOT) LIKE expression to the SQL query. &quot;&quot;&quot;</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">escape_char</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_ESCAPE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">escape_char</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">_const</span><span class="o">.</span><span class="n">CHAR_SPACE</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expression</span><span class="p">))</span>

    <span class="c1"># The following method names do NOT conform to PEP8 conventions.</span>
    <span class="c1"># However, this is done for the sake of consistency and readability,</span>
    <span class="c1"># since some lowercase method names like &quot;and&quot; or &quot;or&quot; would otherwise</span>
    <span class="c1"># conflict with Python&#39;s built-in operators.</span>
    <span class="c1"># Furthermore, since all these methods return a new Where instance,</span>
    <span class="c1"># using Pascal case makes it clear that these methods are &quot;special&quot;.</span>

<div class="viewcode-block" id="Where.And"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.And">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">And</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Where&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new field or another SQL query to a new instance of the current SQL query,</span>
<span class="sd">        separated by an &quot;AND&quot; statement and returns it.</span>

<span class="sd">        :param field_or_clause:     A field name or another ``Where`` instance.</span>
<span class="sd">        :type field_or_clause:      str, unicode, Where</span>
<span class="sd">        :rtype:                     Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_AND</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.Or"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.Or">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">Or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Where&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new field or another SQL query to a new instance of the current SQL query,</span>
<span class="sd">        separated by an &quot;OR&quot; statement and returns it.</span>

<span class="sd">        :param field_or_clause:     A field name or another ``Where`` instance.</span>
<span class="sd">        :type field_or_clause:      str, unicode, Where</span>
<span class="sd">        :rtype:                     Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_OR</span><span class="p">,</span> <span class="n">field_or_clause</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.In"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.In">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">In</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds an IN expression to a copy of the current instance to complete the SQL query and returns it.</span>
<span class="sd">        The given input values must have similar data types. The values will be ordered and duplicates are removed.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_IN</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.NotIn"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.NotIn">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">NotIn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a NOT IN expression to a copy of the current instance to complete the SQL query and returns it.</span>
<span class="sd">        The given input values must have similar data types. The values will be ordered and duplicates are removed.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NOT</span> <span class="o">+</span> <span class="n">_const</span><span class="o">.</span><span class="n">CHAR_SPACE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_IN</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.Between"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.Between">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">Between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a BETWEEN expression to a copy of the current instance to complete the SQL query and returns it.</span>
<span class="sd">        The given input values must have similar data types. Only the lower and upper values are used.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_BETWEEN</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.NotBetween"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.NotBetween">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">NotBetween</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a NOT BETWEEN expression to a copy of the current instance to complete the SQL query and returns it.</span>
<span class="sd">        The given input values must have similar data types. Only the lower and upper values are used.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NOT</span> <span class="o">+</span> <span class="n">_const</span><span class="o">.</span><span class="n">CHAR_SPACE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_BETWEEN</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.Like"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.Like">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">Like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">escape_char</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a LIKE expression to a copy of the current instance to complete the SQL query and returns it.</span>
<span class="sd">        Optionally, an escape character can be specified e.g. when a % symbol must be taken literally.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_LIKE</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">escape_char</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.NotLike"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.NotLike">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">NotLike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">escape_char</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a NOT LIKE expression to a copy of the current instance to complete the SQL query and returns it.</span>
<span class="sd">        Optionally, an escape character can be specified e.g. when a % symbol must be taken literally.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NOT</span> <span class="o">+</span> <span class="n">_const</span><span class="o">.</span><span class="n">CHAR_SPACE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_LIKE</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">escape_char</span><span class="p">)</span></div>

<div class="viewcode-block" id="Where.Equals"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.Equals">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">Equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a &quot;=&quot; expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_EQ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Where.NotEquals"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.NotEquals">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">NotEquals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a &quot;&lt;&gt;&quot; expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Where.GreaterThan"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.GreaterThan">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">GreaterThan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a &quot;&gt;&quot; expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_GT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Where.LessThan"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.LessThan">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">LessThan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a &quot;&lt;&quot; expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_LT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Where.GreaterThanOrEquals"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.GreaterThanOrEquals">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">GreaterThanOrEquals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a &quot;&gt;=&quot; expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_GE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Where.LessThanOrEquals"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.LessThanOrEquals">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">LessThanOrEquals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a &quot;&lt;=&quot; expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_LE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Where.IsNull"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.IsNull">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">IsNull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a IS NULL expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_IS</span> <span class="o">+</span> <span class="n">_const</span><span class="o">.</span><span class="n">CHAR_SPACE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NULL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Where.IsNotNull"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.IsNotNull">[docs]</a>    <span class="nd">@_return_new</span>
    <span class="k">def</span> <span class="nf">IsNotNull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a IS NOT NULL expression to a copy of the current instance to complete the SQL query and returns it.</span>

<span class="sd">        :rtype: Where</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_any</span><span class="p">(</span><span class="n">_const</span><span class="o">.</span><span class="n">CHAR_SPACE</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__SQL_IS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NOT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SQL_NULL</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Where.get_kwargs"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.get_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">get_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="n">WHERE_KWARG</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the where clause SQL string representation as a *keyword=value* ``dict``.</span>

<span class="sd">        This can be used in combination with the double-asterisk syntax (``**``) in an *arcpy* tool call, for example.</span>
<span class="sd">        If this function is called with existing keyword arguments, the SQL where clause will be appended/updated.</span>

<span class="sd">        :param keyword:     The name of the SQL keyword argument. By default, this is ``where_clause``.</span>
<span class="sd">        :param kwargs:      An optional existing keyword dictionary to which the where clause should be added.</span>
<span class="sd">        :return:            A keyword dictionary containing the ``where_clause`` key-value pair.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="Where.delimit_fields"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.Where.delimit_fields">[docs]</a>    <span class="k">def</span> <span class="nf">delimit_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasource</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Ws</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the fields in the query by wrapping them in the appropriate delimiters for the current data source.</span>

<span class="sd">        :param datasource:  The path to the data source (e.g. SDE connection, feature class, etc.)</span>
<span class="sd">                            or a :class:`gpf.paths.Workspace` instance.</span>

<span class="sd">        .. seealso::        https://desktop.arcgis.com/en/arcmap/latest/analyze/arcpy-functions/addfielddelimiters.htm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">is_field</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_field</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Call arcpy function on &quot;clean&quot; version of the field name (to prevent adding duplicate delimiters)</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">_arcpy</span><span class="o">.</span><span class="n">AddFieldDelimiters</span><span class="p">(</span>
                    <span class="n">_tu</span><span class="o">.</span><span class="n">to_str</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">_Ws</span><span class="p">)</span> <span class="k">else</span> <span class="n">datasource</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&quot;&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">is_field</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple of all fields (in order of occurrence) that currently participate in the ``Where`` clause.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">is_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span> <span class="k">if</span> <span class="n">is_field</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Returns ``True`` when the query appears to be ready for execution (i.e. has no syntax errors). &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isdirty</span></div>


<span class="c1"># noinspection PyProtectedMember</span>
<div class="viewcode-block" id="combine"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.combine">[docs]</a><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">where_clause</span><span class="p">:</span> <span class="n">Where</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Where</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The `combine` function wraps a :class:`Where` instance in parenthesis &quot;()&quot;.</span>
<span class="sd">    This is typically used to combine 2 or more SQL clauses (delimited by AND or OR) into one.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; combine(Where(&#39;A&#39;).Equals(1).And(&#39;B&#39;).Equals(0)).Or(&#39;C&#39;).IsNull()</span>
<span class="sd">        (A = 1 AND B = 0) OR C IS NULL</span>

<span class="sd">    **Params:**</span>

<span class="sd">    -   **where_clause** (:class:`Where`):</span>

<span class="sd">        Another `Where` instance that should be wrapped in parenthesis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if clause is another Where instance</span>
    <span class="n">_vld</span><span class="o">.</span><span class="n">pass_if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">where_clause</span><span class="p">,</span> <span class="n">Where</span><span class="p">),</span>
                 <span class="ne">ValueError</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Input clause must be of type </span><span class="si">{Where.__name__!r}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Since we will wrap the query in parenthesis, it must be a complete query (not dirty)</span>
    <span class="n">_vld</span><span class="o">.</span><span class="n">pass_if</span><span class="p">(</span><span class="n">where_clause</span><span class="o">.</span><span class="n">is_ready</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Cannot wrap incomplete query in parenthesis&#39;</span><span class="p">)</span>

    <span class="n">wrapper</span> <span class="o">=</span> <span class="n">Where</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">_parts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">_parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="add_where"><a class="viewcode-back" href="../../../gpf.tools.queries.html#gpf.tools.queries.add_where">[docs]</a><span class="k">def</span> <span class="nf">add_where</span><span class="p">(</span><span class="n">keyword_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Where</span><span class="p">],</span>
              <span class="n">datasource</span><span class="p">:</span> <span class="n">_tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_Ws</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the keyword arguments dictionary with a where clause (string or ``Where`` instance).</span>

<span class="sd">    :param keyword_args:    A keyword argument dictionary.</span>
<span class="sd">    :param where_clause:    A query string or a :class:`Where` instance.</span>
<span class="sd">    :param datasource:      If the data source path is specified, the field delimiters are updated accordingly.</span>
<span class="sd">                            This only has an effect if *where_clause* is a :class:`Where` instance.</span>
<span class="sd">    :raises ValueError:     If *where_clause* is not a string or :class:`Where` instance,</span>
<span class="sd">                            or if *keyword_args* is not a ``dict``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">where_clause</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">_vld</span><span class="o">.</span><span class="n">pass_if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">keyword_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;keyword_args must be a dict&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">where_clause</span><span class="p">,</span> <span class="n">Where</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">datasource</span><span class="p">:</span>
            <span class="n">where_clause</span><span class="o">.</span><span class="n">delimit_fields</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span>
        <span class="n">keyword_args</span><span class="p">[</span><span class="n">WHERE_KWARG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">where_clause</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">keyword_args</span><span class="p">[</span><span class="n">WHERE_KWARG</span><span class="p">]</span> <span class="o">=</span> <span class="n">where_clause</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{WHERE_KWARG!r}</span><span class="s1"> must be a string or </span><span class="si">{Where.__name__}</span><span class="s1"> instance&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Geocom Informatik AG / VertiGIS, Burgdorf, Switzerland

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>